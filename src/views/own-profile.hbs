<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="/styles/own-profile.css">
        <link rel="shortcut icon" href="/assets/tab-icon.png" type="image/x-icon">
        <script src="/script/own-profile.js"></script>
        <script src="/script/general.js"></script>
        <script src="/script/edit-profile.js" defer></script>
        <script src="/script/like.js"></script>
        <script src="/script/general.js"></script>

        <!-- quill -->
        <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
        <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
        <script src="https://unpkg.com/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/js/bootstrap.min.js"></script>



        <title>@{{profile.username}}'s Profile - BiteBoxd</title>
    </head>
<body>
    {{> navbar}}



    <main>
        <div class="profile-header">
            <img src="/assets/{{profile.bgImage}}" alt="header" class="header-picture">
        </div>
        
        <div class="profile">
            <div class="info-container">
                <div class="handle-edit">
                    <div class="handle">
                        <h1 id="profile-username">@{{profile.username}}</h1>
                    </div>
                    <div class="edit">
                        <button class="edit-btn">Edit Profile</button>

                        <!-- edit profile popup-->
                        <div id="editProfileModal" class="modal">
                            <div class="modal-content">
                                <span class="close-button">&times;</span>
                                <h2>Edit Profile</h2>
                                <form id="editProfileForm" action="/edit-profile" method="POST" enctype="multipart/form-data">
                                    <div class="form-group">
                                        <label for="profilePic">Profile Picture:</label>
                                        <input type="file" id="profilePic" name="profilePic">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="backgroundPic">Background Picture:</label>
                                        <input type="file" id="backgroundPic" name="backgroundPic">
                                    </div>

                                    <div class="form-group">
                                        <label for="firstName">First Name:</label>
                                        <input type="text" id="firstName" name="firstName" required>
                                    </div>

                                    <div class="form-group">
                                        <label for="lastName">Last Name:</label>
                                        <input type="text" id="lastName" name="lastName" required>
                                    </div>

                                    <div class="form-group">
                                        <label for="bio">Bio:</label>
                                        <textarea id="bio" name="bio" required></textarea>
                                    </div>
                                    
                                    <div class="form-group save-changes-div">
                                        <button type="submit" class="save-changes">Save Changes</button>
                                    </div>
                                </form>

                            </div>
                            
                        </div>

                    </div>
                </div>
                
        
                <div class="user-info">
                    <div class="fullname">
                        <img src="/assets/full-name-icon.png" alt="full name icon" class="icon">
                        <h3 id="first-name">{{profile.firstName}}</h3> <h3>&nbsp;</h3> <h3 id="last-name">{{profile.lastName}}</h3>
                    </div>
                    <div class="date-created">
                        <img src="/assets/calendar.png" alt="date icon" class="icon">
                        <h3>{{formatMonthYear profile.createdAt}}</h3>
                    </div>
                </div>
                <div class="bio">
                    <p>bio:&nbsp;</p> <p id="profile-bio">{{profile.bio}}</p>
                </div>
            </div>
            <div class="profile-tabs"> 
                <button class="tab-btn" id="Reviews"> Reviews</button>
                <button class="tab-btn" id="about">About</button>
                <div class="line"></div>
            </div>

        <div class="content-box">

            <!-- Liked Restaurants -->
            <div class="content">
                {{#each reviews}}
                   <div class="review" data-review-id="{{this._id}}"> 
                        <div class="review-panel">
                            <div class="profile-score">
                                <div class="profilearea">
                                    <img src="/uploads/avatars/{{../profilePicture}}" alt="Profile Picture" class="profilepic" id="profile-icon">
                                </div>
                                <div class="score">
                                    <h2 class="yellowscore" id="user-score">{{this.overallRating}}</h2>
                                </div>
                            </div>

                            <div class="review-center-tile">
                                <div class="score-username">
                                    <h2 class="titlearea">{{this.title}}</h2>
                                    <div class="nametitle">
                                        <a href="/profile/{{this.username}}" class="nameandtime">{{this.username}}</a>
                                        <p class="nameandtime"> ¬∑ </p>
                                        <p class="nameandtime">{{formatDate this.createdAt}}</p>
                                    </div>
                                </div>
                                <div class="criteriaratings">
                                    <div class="criteriascore">
                                        <h4 class="criteria">Food Quality</h4>
                                        <div class="stars">
                                            {{#times this.foodRating}}
                                                <span>üçó</span>
                                            {{/times}}
                                        </div>
                                    </div>
                                    <div class="criteriascore">
                                        <h4 class="criteria">Service</h4>
                                        <div class="stars">
                                            {{#times this.serviceRating}}
                                                <span>ü§ù</span>
                                            {{/times}}
                                        </div>
                                    </div>
                                    <div class="criteriascore">
                                        <h4 class="criteria">Affordability</h4>
                                        <div class="stars">
                                            {{#times this.affordabilityRating}}
                                                <span>üíµ</span>
                                            {{/times}}
                                        </div>
                                    </div>
                                </div>

                                <div class="reviewtext" id="{{@index}}">
                                    <span class="longtext">{{this.body}}</span>
                                    {{!-- <span class="longtext">{{longText}}</span>
                                    {{#unless hasNoSeeMore}}
                                        <span class="full-text">{{fullText}}</span>
                                        <span class="see-more" onclick="toggleSeeMore('this._id')"><b>...see more</b></span>
                                    {{/unless}} --}}
                                    {{!-- <span class="read-more">Read more...</span> --}}
                                </div>
                            </div>
                                <div class="review-popup">
                                    <div class="react-container">
                                        <button class="like-dislike" id="like">&#128077;</button>
                                        <span class = "numberoffeedback">9</span>
                                        <button class="like-dislike" id="dislike">&#128078;</button>
                                        <span class="numberoffeedback">8</span>
                                    </div>
                                    <div class="options-button" onclick="toggleOptions(this)">
                                        &nbsp;&nbsp;&#8286;
                                        <div class="options-popup">
                                            <a href="#" data-action="editReview">Edit</a>
                                            <a href="#" onclick="deleteReview(this)">Delete</a>
                                        </div>
                                    </div>
                                </div>       
                        </div>
                        <div class="photopanel">
                            {{#each this.media}}
                                <img src="/assets/{{this}}" class="revpic">
                            {{/each}}
                        </div>
                    </div>
                {{else}}
                    <p>No reviews found.</p>
                {{/each}}
            </div>
           
            


            <!-- Reviews -->

            

            {{!-- Edit reviw form --}}
            <div class="modal fade" id="editReviewModal" tabindex="-1" aria-labelledby="editReviewModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editReviewModalLabel">Edit Review</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editReviewForm">
                                <input type="hidden" id="editReviewId" value="">

                                <div class="mb-3">
                                    <label for="editTitle" class="form-label">Title</label>
                                    <input type="text" class="form-control" name="editTitle" id="editTitle" required>
                                </div>

                                <div class="mb-3">
                                    <label for="editBody" class="form-label">Review</label>
                                    <textarea class="form-control" name="editBody" id="editBody" rows="3" required></textarea>
                                </div>

                                <div class="mb-3">
                                    <label for="editMedia" class="form-label">Media</label>
                                    <div id="editMediaPreview" class="mb-2">

                                    </div>
                                    <input type="file" class="form-control" name="editMedia" id="editMedia" multiple>
                                </div>

                                <div class="mb-3">
                                    <label for="editFoodRating" class="form-label">Food Quality Rating</label>
                                    <input type="number" class="form-control" name="editFoodRating" id="editFoodRating" min="1" max="5" required>
                                </div>

                                <div class="mb-3">
                                    <label for="editServiceRating" class="form-label">Service Rating</label>
                                    <input type="number" class="form-control" name="editServiceRating" id="editServiceRating" min="1" max="5" required>
                                </div>

                                <div class="mb-3">
                                    <label for="editAffordabilityRating" class="form-label">Affordability Rating</label>
                                    <input type="number" class="form-control" name="editAffordabilityRating" id="editAffordabilityRating" min="1" max="5" required>
                                </div>
                                

                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary" form="editReviewForm">Save Changes</button>
                        </div>
                    </div>
                </div>
            </div>

           
            

            <!-- About -->
            <div class="content">
                <div class="user-ratings-container">
                    <!-- Ratings section -->
                    <div class="rating-labelled">
                        <div class="rating-label-percentage">
                            <p class="number-about">{{profile.hearts}}</p>
                            <p class="label-about">Likes</p>
                        </div>
                    </div>
                    <div class="rating-labelled">
                        <div class="rating-label-percentage">
                            <p class="number-about">{{profile.dislike}}</p>
                            <p class="label-about">Dislikes</p>
                        </div>
                    </div>
                    <div class="rating-labelled">
                        <div class="rating-label-percentage">
                            <p class="number-about">{{profile.credibility}}</p>
                            <p class="label-about">Credibility</p>
                        </div>
                    </div>
                </div>
                <div class="divider"></div>
                <!-- Taste profile section -->
                <div class="taste-profile-container">
                    <h2 class="taste-profile-label">Taste Profile</h2>
                    <div class="taste-profile-items">
                        {{#each profile.tasteProfile}}
                            <div class="taste-profile-item">{{this}}</div>
                        {{/each}}
                    </div>
                </div>

                <div class="divider"></div>
                <div class="recent-activities-container">

                <h2 class="taste-profile-label">Reviews You've Liked</h2>
                {{!-- {{#if profile.likedReviews.length}} --}}
                    {{#each likedReviews}}
                   <div class="review" data-review-id="{{this._id}}"> 
                        <div class="review-panel">
                            <div class="profile-score">
                                <div class="profilearea">
                                    <img src="/uploads/avatars/{{../this.likedReviewsProfilePictures}}" alt="Profile Picture" class="profilepic" id="profile-icon">
                                </div>
                                <div class="score">
                                    <h2 class="yellowscore" id="user-score">{{this.overallRating}}</h2>
                                </div>
                            </div>

                            <div class="review-center-tile">
                                <div class="score-username">
                                    <h2 class="titlearea">{{this.title}}</h2>
                                    <div class="nametitle">
                                        <a href="/profile/{{this.username}}" class="nameandtime">{{this.username}}</a>
                                        <p class="nameandtime"> ¬∑ </p>
                                        <p class="nameandtime">{{formatDate this.createdAt}}</p>
                                    </div>
                                </div>
                                <div class="criteriaratings">
                                    <div class="criteriascore">
                                        <h4 class="criteria">Food Quality</h4>
                                        <div class="stars">
                                            {{#times this.foodRating}}
                                                <span>üçó</span>
                                            {{/times}}
                                        </div>
                                    </div>
                                    <div class="criteriascore">
                                        <h4 class="criteria">Service</h4>
                                        <div class="stars">
                                            {{#times this.serviceRating}}
                                                <span>ü§ù</span>
                                            {{/times}}
                                        </div>
                                    </div>
                                    <div class="criteriascore">
                                        <h4 class="criteria">Affordability</h4>
                                        <div class="stars">
                                            {{#times this.affordabilityRating}}
                                                <span>üíµ</span>
                                            {{/times}}
                                        </div>
                                    </div>
                                </div>

                                <div class="reviewtext" id="{{@index}}">
                                    <span class="longtext">{{this.body}}</span>
                                    {{!-- <span class="longtext">{{longText}}</span>
                                    {{#unless hasNoSeeMore}}
                                        <span class="full-text">{{fullText}}</span>
                                        <span class="see-more" onclick="toggleSeeMore('this._id')"><b>...see more</b></span>
                                    {{/unless}} --}}
                                    {{!-- <span class="read-more">Read more...</span> --}}
                                </div>
                            </div>
                                <div class="review-popup">
                                    <div class="react-container">
                                        <button class="like-dislike" id="like">&#128077;</button>
                                        <span class = "numberoffeedback">9</span>
                                        <button class="like-dislike" id="dislike">&#128078;</button>
                                        <span class="numberoffeedback">8</span>
                                    </div>
                                    <div class="options-button" onclick="toggleOptions(this)">
                                        &nbsp;&nbsp;&#8286;
                                        <div class="options-popup">
                                            <a href="#" onclick="deleteReview(this)">Delete</a>
                                        </div>
                                    </div>
                                </div>       
                        </div>
                        <div class="photopanel">
                            {{#each this.media}}
                                <img src="/assets/{{this}}" class="revpic">
                            {{/each}}
                        </div>
                    </div>
                {{else}}
                    <p>No reviews found.</p>
                {{/each}}

                <div class="divider"></div>

                <div class="delete-profile-container">
                <button class="delete-profile" onclick="deleteProfile()">Delete Profile</button>
                </div>
            </div>
            </div>


        </div>
            </div>
        <div class="avatar-container">
            <div class="avatar-boorder">
                <div class="avatar">
                    <img src="/uploads/avatars/{{profilePicture}}" alt="Profile Avatar" id="profile-pic" class="profile-pic">
                    {{!-- <img src="/{{session.profilePicture}}" alt="Profile Picture" id="profile-pic"> --}}

                </div>
            </div>
        </div>
    </main>
    <script>
        adjustNavBar();

        const likesets = document.getElementsByClassName('react-container');
        const likes = []
        // console.log(likeDislikeButtons)


        Array.from(likesets).forEach(likeset => {
            let likeButton = likeset.querySelector('#like');
            let dislikeButton = likeset.querySelector('#dislike');
            likes.push(new Like(likeButton, dislikeButton))
        });

        
        Array.from(likes).forEach(like => {
            like.initializeClick();
        });



        console.log(likes)
        adjustNavBar();
        detectLogin();

        document.getElementById("title").addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
            }
        });


        console.log(likes)

        function deleteProfile(){
    Swal.fire({
        title: 'Delete Profile',
        text: 'Are you sure you want to delete your account?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'No, cancel!',
        reverseButtons: true,
        customClass: {
            container: 'swal-custom-font', 
        }
    }).then((result) => {
        if (result.isConfirmed) {
            Swal.fire({
                title: 'Confirm Deletion',
                text: 'To confirm deletion, type \'Confirm\':',
                input: 'text',
                showCancelButton: true,
                cancelButtonText: 'Cancel',
                confirmButtonText: 'Submit',
                inputValidator: (value) => {
                    if (value !== "Confirm") {
                        return 'You need to enter the correct confirmation text!';
                    }
                },
                customClass: {
                    container: 'swal-custom-font', 
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    
                    Swal.fire({
                        title: 'Final Confirmation',
                        text: `Are you sure you want to delete? This action cannot be undone.`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Yes, delete it!',
                        cancelButtonText: 'No, cancel!',
                        reverseButtons: true,
                        customClass: {
                            container: 'swal-custom-font', 
                        }
                    }).then((result) => {
                        Swal.fire({
                            title: 'Success!',
                            text: 'Your account has been successfully deleted.',
                            icon: 'success',
                            confirmButtonText: 'OK',
                            timer: 3000, 
                            timerProgressBar: true 
                        }).then(() => {
                            window.location.href = '/logout';
                        });
                    });
                    
                }
                
            });
        }
    });
}

    </script>
</body>
</html>